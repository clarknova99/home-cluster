# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
---
  name: "Flux Diff"

  on:
    pull_request:
      branches: ["main"]
      paths: ["kubernetes/**.yaml"]

  jobs:
    flux-diff:
      name: Flux Diff
      runs-on: ubuntu-latest
      permissions:
        pull-requests: write
      strategy:
        matrix:
          path: ["kubernetes"]
          resource: ["helmrelease", "kustomization"]
      steps:
        - name: Generate Token
          uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a # v2.1.0
          id: generate-token
          with:
            app_id: "${{ secrets.BOT_APP_ID }}"
            private_key: "${{ secrets.BOT_APP_PRIVATE_KEY }}"

        - name: Login to GitHub Container Registry
          uses: docker/login-action@e92390c5fb421da1463c202d546fed0ec5c39f20 # v3.1.0
          with:
            registry: ghcr.io
            username: "${{ secrets.BOT_APP_ID }}"
            password: "${{ steps.generate-token.outputs.token }}"

        - name: Diff Resources
          uses: docker://ghcr.io/allenporter/flux-local:main
          with:
            args: >-
              diff ${{ matrix.resources }}
              --unified 6
              --path /github/workspace/pull/${{ matrix.paths }}/flux
              --path-orig /github/workspace/default/${{ matrix.paths }}/flux
              --strip-attrs "helm.sh/chart,checksum/config,app.kubernetes.io/version,chart"
              --limit-bytes 10000
              --all-namespaces
              --sources "home-kubernetes"
              --output-file diff.patch
        - name: Generate Diff
          id: diff
          run: |
            cat diff.patch
            echo "diff<<EOF" >> $GITHUB_OUTPUT
            cat diff.patch >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

        - if: ${{ steps.diff.outputs.diff != '' }}
          name: Add comment
          uses: mshick/add-pr-comment@v2
          with:
            message-id: "${{ github.event.pull_request.number }}/${{ matrix.paths }}/${{ matrix.resources }}"
            message-failure: Diff was not successful
            message: |
              ```diff
              ${{ steps.diff.outputs.diff }}
