---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: authelia
  namespace: networking
spec:
  chart:
    spec:
      chart: authelia
      reconcileStrategy: ChartVersion
      sourceRef:
        kind: HelmRepository
        name: authelia
        namespace: flux-system
      interval: 15m
  install:
    createNamespace: true
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5
  values:
    global:
      nameOverride: authelia
    controller:
      replicas: 1
      strategy: RollingUpdate
      annotations:
        reloader.stakater.com/auto: "true"
    # image:
    #   registry: ghcr.io
    #   repository: authelia/authelia
    #   tag: '4.37.5'
    containers:
      - name: authelia
        image: docker.io/authelia/authelia:fix-missing-head-handler
        command:
          - authelia
        args:
          - '--config=/data/authelia/config/configuration.yaml'

    # command:
    #   - sh
    #   - -c
    #   - authelia --config /data/authelia/config/configuration.yaml
    # volumeMounts:
    #   - mountPath: "/config"
    #     name: data
    # env:
    #   X_AUTHELIA_CONFIG: /data/authelia/config/configuration.yaml
    configMap:
      # Enable the configMap source for the Authelia config.
      # If this is false you need to provide a volumeMount via PV/PVC or other means that mounts to /config.
      enabled: false
    service:
      main:
        ports:
          http:
            port: 80
    persistence:
      name: data
      enabled: true
      accessMode: ReadWriteMany
      path: /data
      #subPath: /data/authelia/config
      existingClaim: pvc-networking
    resources:
      requests:
        cpu: 5m
        memory: 10Mi
      limits:
        memory: 100Mi
  interval: 10m0s
