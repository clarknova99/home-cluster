---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: authelia
  namespace: networking
spec:
  chart:
    spec:
      chart: authelia
      reconcileStrategy: ChartVersion
      sourceRef:
        kind: HelmRepository
        name: authelia
        namespace: flux-system
      interval: 15m
  install:
    createNamespace: true
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5
  values:
    # global:
    #   nameOverride: authelia
    controller:
      replicas: 1
      strategy: RollingUpdate
      annotations:
        reloader.stakater.com/auto: "true"
    image:
      registry: ghcr.io
      repository: authelia/authelia
      tag: '4.37.5'
    args: ["--config", "/data/authelia/configuration.yaml"]
    #args: ["--config", "/data/authelia/config/configuration.yaml", "--config.experimental.filters", "expand-env"]
    # containers:
    #   - name: authelia
    #     image: docker.io/authelia/authelia:fix-missing-head-handler
    #     command:
    #       - authelia
    #     args:
    #       - '--config=/data/authelia/config/configuration.yaml'

    # command:
    #   - sh
    #   - -c
    #   - authelia --config /data/authelia/config/configuration.yaml
    # volumeMounts:
    #   - mountPath: "/config"
    #     name: data
    # env:
    #   X_AUTHELIA_CONFIG: /data/authelia/config/configuration.yaml


    service:
      main:
        ports:
          http:
            port: 9091
    persistence:
      data:
        enabled: true
        accessMode: ReadWriteMany
        path: /data
        existingClaim: pvc-networking
      config:
        enabled: true
        accessMode: ReadWriteMany
        path: /data/authelia/configuration.yaml
        existingClaim: pvc-networking
      # config:
      #   enabled: true
      #   existingClaim: pvc-networking
      #   path: /data/authelia

    resources:
      requests:
        cpu: 5m
        memory: 10Mi
      limits:
        memory: 100Mi
  interval: 10m0s
