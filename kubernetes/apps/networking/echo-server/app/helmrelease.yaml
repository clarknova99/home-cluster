---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: echo-server
  namespace: networking
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 2.0.2
      interval: 30m
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system

    values:
      controllers:
        main:
          annotations:
            reloader.stakater.com/auto: "true"

          containers:
            main:
              image:
                repository: ghcr.io/mendhak/http-https-echo
                tag: 30
              env:
                HTTP_PORT: &port 8080
                LOG_WITHOUT_NEWLINE: "true"
                LOG_IGNORE_PATH: "/healthz"
              resources:
                requests:
                  cpu: 5m
                  memory: 30M
                limits:
                  memory: 30M
      service:
        main:
          ports:
            http:
              port: *port

      ingress:
        main:
          enabled: true
          ingressClassName: external
          annotations:
            external-dns.alpha.kubernetes.io/target: "external.${SECRET_DOMAIN}"
            nginx.ingress.kubernetes.io/auth-method: GET
            nginx.ingress.kubernetes.io/auth-url: http://authelia.networking.svc.cluster.local/api/verify
            nginx.ingress.kubernetes.io/auth-signin: https://auth.${SECRET_DOMAIN}?rm=$request_method
            nginx.ingress.kubernetes.io/auth-response-headers: Remote-User,Remote-Name,Remote-Groups,Remote-Email
            nginx.ingress.kubernetes.io/auth-snippet: proxy_set_header X-Forwarded-Method $request_method;
            hajimari.io/icon: video-input-antenna
          hosts:
            - host: &host "{{ .Release.Name }}.${SECRET_DOMAIN}"
              paths:
                - path: /
                  pathType: Prefix
            - host: &host2 "{{ .Release.Name }}.${SECRET_DOMAIN2}"
              paths:
                - path: /
                  pathType: Prefix
          tls:
            - hosts:
                - *host
                - *host2
