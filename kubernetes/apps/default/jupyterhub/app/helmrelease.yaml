apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: jupyterhub
  namespace: dev
spec:
  interval: 15m
  chart:
    spec:
      chart: jupyterhub
      version: 3.1.0
      sourceRef:
        kind: HelmRepository
        name: jupyterhub
        namespace: flux-system
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    hub:
      nodeSelector:
        kubernetes.io/arch: amd64
      config:
        Authenticator:
          admin_users:
            - ${SECRET_AUTHELIA_DISPLAY_NAME}
        GenericOAuthenticator:
          client_id: jupyterhub
          client_secret: ${SECRET_JUPYTERHUB_OAUTH_CLIENT_SECRET}
          oauth_callback_url: "https://jupyterhub.${SECRET_DOMAIN}/hub/oauth_callback"
          authorize_url: https://auth.${SECRET_DOMAIN}/api/oidc/authorization
          token_url: https://auth.${SECRET_DOMAIN}/api/oidc/token
          userdata_url: https://auth.${SECRET_DOMAIN}/api/oidc/userinfo
          scope:
            - openid
            - profile
            - email
          username_key: preferred_username
        JupyterHub:
          authenticator_class: generic-oauth
    singleuser:
      image:
        #https://jupyter-docker-stacks.readthedocs.io/en/latest/using/selecting.html
        name: jupyter/pyspark-notebook
        tag: latest
      # profileList:
      #   - display_name: "Minimal environment"
      #     description: "To avoid too much bells and whistles: Python."
      #   - display_name: "Datascience environment"
      #     description: "If you want the additional bells and whistles: Python, R, and Julia."
      #     kubespawner_override:
      #       image: jupyter/datascience-notebook:latest
      #     default: true
      #   - display_name: "Haskell environment"
      #     description: "The Jupyter Stacks ihaskell"
      #     kubespawner_override:
      #       image: ghcr.io/jamesdbrock/ihaskell-notebook:master
      # extraEnv:
      #   EDITOR: "vim"
      storage:
        extraVolumes:
          - name: jupyterhub
            persistentVolumeClaim:
              claimName: pvc-jupyterhub
        extraVolumeMounts:
          - name: jupyterhub
            mountPath: /home/shared

    ingress:
      enabled: true
      annotations:
        external-dns.alpha.kubernetes.io/target: "external.${SECRET_DOMAIN}"
        hajimari.io/icon: simple-icons:jupyter
      hosts:
        - &host "jupyter.${SECRET_DOMAIN}"
      tls:
        - hosts:
            - *host
