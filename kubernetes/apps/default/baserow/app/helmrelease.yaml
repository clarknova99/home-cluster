---
# The backend ASGI worker handling websockets
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: baserow-backend-asgi
  namespace: default
  labels:
    app: baserow-backend-asgi
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 1.5.1
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
      interval: 15m
  maxHistory: 3
  install:
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5
  values:
    controller:
      replicas: 1
    service:
      type: ClusterIP
      main:
        ports:
          http:
            port: 80
            targetPort: 8000
    envFrom:
      - secretRef:
          name: baserow-secret
    image:
      repository: docker.io/baserow/backend
      tag: 1.20.2
      args: ["gunicorn"]
      # ports:
      #   - containerPort: 8000
      #     name: backend-asgi
      probes:
        readiness:
          custom: true
          spec:
            httpGet:
              path: /api/_health/
              port: 8000
---
# The backend WSGI worker handling normal http api requests
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: baserow-backend-wsgi
  namespace: default
  labels:
    app: baserow-backend-wsgi
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 1.5.1
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
      interval: 15m
  maxHistory: 3
  install:
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5
  values:
    controller:
      replicas: 1
    service:
      type: ClusterIP
      main:
        ports:
          http:
            port: 80
            targetPort: 8000
    envFrom:
      - secretRef:
          name: baserow-secret
    image:
      repository: docker.io/baserow/backend
      tag: 1.20.2
      args:
        - "gunicorn-wsgi"
        - "--timeout"
        - "60"
      # ports:
      #   - containerPort: 8000
      #     name: backend-asgi
      probes:
        readiness:
          custom: true
          spec:
            httpGet:
              path: /api/_health/
              port: 8000
---
# A set of celery workers handling realtime events, cleanup, async tasks etc.
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: baserow-backend-worker
  namespace: default
  labels:
    app: baserow-backend-worker
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 1.5.1
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
      interval: 15m
  maxHistory: 3
  install:
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5
  values:
    controller:
      replicas: 2
    service:
      type: ClusterIP
      main:
        ports:
          http:
            port: 80
            targetPort: 8000
    envFrom:
      - secretRef:
          name: baserow-secret
    image:
      repository: docker.io/baserow/backend
      tag: 1.20.2
      args:
        - "gunicorn-wsgi"
        - "--timeout"
        - "60"
      # ports:
      #   - containerPort: 8000
      #     name: backend-asgi
      probes:
        readiness:
          custom: true
          spec:
            httpGet:
              path: /api/_health/
              port: 8000
