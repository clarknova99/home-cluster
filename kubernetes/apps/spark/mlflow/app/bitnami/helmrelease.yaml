---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2beta1.json
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: mlflow
  namespace: spark
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://charts.bitnami.com/bitnami
      chart: mlflow
      version: 0.8.0
      sourceRef:
        kind: HelmRepository
        name: bitnami
        namespace: flux-system
      interval: 5m
  values:
    service:
      annotations:
        io.cilium/lb-ipam-ips: "192.168.2.44"
      externalTrafficPolicy: Cluster
      type: LoadBalancer
      # -- Default Service port
      port: 5000
      # -- Default Service name
      name: mlflow
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: kubernetes.io/arch
                  operator: In
                  values:
                    - amd64

    postgres:
      enabled: false
    externalDatabase:
      host: cloudnative-pg-cluster.database.svc.cluster.local
      port: 5432
      database: mlflow
      user: postgres
      password: ${SECRET_POSTGRES_PASSWORD}

    externalS3:
      host: minio.kube-system.svc.cluster.local
      port: 9000
      useCredentialsInSecret: true
      accessKeyID: ${SECRET_MINIO_ACCESS_KEY}
      accessKeySecret: ${SECRET_MINIO_SECRET_KEY}
      protocol: "http"
      bucket: "mlflow"
      serveArtifacts: true
    # -- Extra Volumes for the pod
    extraVolumes:
    - name: google-credentials-creds
      secret:
        secretName: google-credentials-creds

    # -- Extra Volume Mounts for the mlflow container
    extraVolumeMounts:
    - name: google-credentials-creds
      mountPath: /app/config/google
