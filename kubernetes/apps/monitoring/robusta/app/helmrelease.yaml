---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: &app robusta
  namespace: monitoring
spec:
  interval: 15m
  chart:
    spec:
      chart: robusta
      version: 0.10.22
      sourceRef:
        kind: HelmRepository
        name: robusta
        namespace: flux-system
      interval: 15m
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:

    #https://github.com/robusta-dev/robusta/blob/master/helm/robusta/values.yaml

    clusterName: home-ops
    # envFrom:
    # ## sops --encrypt --in-place ./kubernetes/apps/monitoring/robusta/app/robusta.sops.yaml
    # ## sops --decrypt ./kubernetes/apps/monitoring/robusta/app/robusta.sops.yaml | kubectl apply -f -
    #   - secretRef:
    #       name: *app
    # see https://docs.robusta.dev/master/user-guide/configuration.html#global-config
    globalConfig:
      grafana_url: "grafana.${SECRET_DOMAIN}"
      prometheus_url: "prometheus.${SECRET_DOMAIN}"
      signing_key: ${GLOBAL_CONFIG_SIGNING_KEY}
      account_id: ${GLOBAL_ACCOUNT_ID}
    rsa:
      private: ${RSA_PRIVATE}
      public: ${RSA_PUBLIC}

    sinksConfig:
      - slack_sink:
          name: main_slack_sink
          slack_channel: test
          api_key: "${SLACK_SINK_API_KEY}"

      - robusta_sink:
          name: robusta_ui_sink
          token: "${ROBUSTA_SINK_TOKEN}"

    enablePlatformPlaybooks: true

    runner:
      sendAdditionalTelemetry: false
      log_level: DEBUG
      #additional_env_vars: []
      # additional_env_froms:
      #   - secretRef:
      #       name: robusta
      resources:
        requests:
          cpu: 250m
          memory: 1024Mi
        limits:
          cpu: ~
          memory: 2048Mi
